{
  "overview": {
    "totalViolations": 64,
    "errors": 42,
    "warnings": 22,
    "categories": ["test-files", "commands", "web-dashboard", "logger", "unused-variables"],
    "estimatedEffortHours": 18,
    "estimatedComplexity": "medium",
    "targetComplexityMetrics": {
      "maxLinePeFunction": 50,
      "maxLinesPeDescribeBlock": 150,
      "maxStatementsPeFunction": 25,
      "maxComplexity": 15,
      "maxDepth": 4
    }
  },
  "violationDetails": {
    "testFiles": {
      "category": "Describe blocks exceeding 200 lines",
      "count": 9,
      "files": [
        {
          "file": "__tests__/unit/services/perplexity-secure-comprehensive.test.js",
          "line": 36,
          "description": "Main describe block",
          "lineCount": 681,
          "statements": 120,
          "severity": "CRITICAL",
          "reason": "LARGEST - Contains 20+ nested describe blocks, 100+ test cases, mixed concerns"
        },
        {
          "file": "__tests__/unit/services/perplexity-secure-private-methods.test.js",
          "line": 34,
          "description": "Private methods describe block",
          "lineCount": 265,
          "statements": 95,
          "severity": "HIGH",
          "reason": "Tests multiple private methods in single block"
        },
        {
          "file": "__tests__/unit/services/database.test.js",
          "line": 28,
          "description": "Main DatabaseService describe block",
          "lineCount": 222,
          "statements": 88,
          "severity": "HIGH",
          "reason": "Mixed database concerns: CRUD, reminders, stats, users"
        },
        {
          "file": "__tests__/unit/error-handler-critical-coverage.test.js",
          "line": 23,
          "description": "Error handler critical tests",
          "lineCount": 281,
          "statements": 102,
          "severity": "HIGH",
          "reason": "Multiple error scenarios combined"
        },
        {
          "file": "__tests__/unit/index-critical-coverage.test.js",
          "line": 6,
          "description": "Index critical coverage",
          "lineCount": 241,
          "statements": 91,
          "severity": "HIGH",
          "reason": "Integration tests with multiple concerns"
        },
        {
          "file": "__tests__/unit/index.test.js",
          "line": 149,
          "description": "Main index tests",
          "lineCount": 245,
          "statements": 92,
          "severity": "HIGH",
          "reason": "Mixed bot initialization and handler tests"
        },
        {
          "file": "__tests__/unit/logger-critical-coverage.test.js",
          "line": 28,
          "description": "Logger critical coverage tests",
          "lineCount": 272,
          "statements": 98,
          "severity": "HIGH",
          "reason": "All logger methods tested in single block"
        },
        {
          "file": "__tests__/unit/services/reminder-service.test.js",
          "line": 9,
          "description": "Reminder service main tests",
          "lineCount": 308,
          "statements": 110,
          "severity": "HIGH",
          "reason": "LARGEST service test - all reminder functionality"
        },
        {
          "file": "__tests__/unit/reminder.test.js",
          "line": 30,
          "description": "Legacy reminder tests",
          "lineCount": 225,
          "statements": 84,
          "severity": "HIGH",
          "reason": "Duplicate coverage with reminder-service.test.js"
        }
      ],
      "refactoringApproach": "Split Large Describe Blocks (SAME FILE)",
      "refactoringDetails": {
        "strategy": "Use nested describe blocks for logical grouping - no file splitting required",
        "benefits": [
          "Jest supports nested describe() blocks natively",
          "Maintains test file organization",
          "Improves test readability and navigation",
          "Enables selective test runs by describe block",
          "Better error reporting with clear hierarchy"
        ],
        "limitations": [
          "Still maintains single file for easy imports",
          "beforeEach/afterEach scope properly nested",
          "Shared test utilities extracted to helpers"
        ]
      }
    },
    "commands": {
      "category": "execute() methods exceeding complexity/line limits",
      "count": 5,
      "file": "src/commands/index.js",
      "violations": [
        {
          "line": 261,
          "commandName": "analytics",
          "execute_methods": [
            {
              "name": "execute (analytics command)",
              "lines": 98,
              "statements": 28,
              "complexity": 12,
              "severity": "HIGH",
              "issues": [
                "Embed creation with 8+ field definitions",
                "Data fetching and transformation",
                "Error handling mixed with business logic"
              ]
            }
          ]
        },
        {
          "line": 385,
          "commandName": "dashboard",
          "execute_methods": [
            {
              "name": "execute (dashboard command)",
              "lines": 87,
              "statements": 27,
              "complexity": 11,
              "severity": "HIGH",
              "issues": [
                "Conditional embed color assignment (3-way ternary)",
                "Multiple status calculations",
                "6+ field embed definitions"
              ]
            }
          ]
        },
        {
          "line": 491,
          "commandName": "resources",
          "execute_methods": [
            {
              "name": "execute (resources command)",
              "lines": 61,
              "statements": 18,
              "complexity": 8,
              "severity": "MEDIUM",
              "issues": [
                "Embed color logic",
                "Multiple data sources coordination"
              ]
            }
          ]
        },
        {
          "line": 580,
          "commandName": "cache",
          "execute_methods": [
            {
              "name": "execute (cache command)",
              "lines": 55,
              "statements": 16,
              "complexity": 7,
              "severity": "MEDIUM"
            }
          ]
        },
        {
          "line": 650,
          "commandName": "reminder",
          "execute_methods": [
            {
              "name": "execute (reminder command)",
              "lines": 48,
              "statements": 14,
              "complexity": 6,
              "severity": "MEDIUM"
            }
          ]
        }
      ],
      "refactoringApproach": "Extract Helper Methods Pattern",
      "pattern": {
        "before": "execute() method contains embed creation + data fetching + error handling",
        "after": "execute() orchestrates; helpers handle specific concerns",
        "structure": {
          "execute": "Orchestrator - calls helpers in sequence",
          "_buildXxxEmbed": "Creates and returns embed object",
          "_fetchXxxData": "Fetches and transforms data",
          "_handleXxxError": "Formats error responses"
        }
      }
    },
    "webDashboard": {
      "category": "Complex methods with high lines/statements/complexity/depth",
      "count": 25,
      "file": "src/services/web-dashboard.js",
      "totalLines": 3372,
      "violations": [
        {
          "line": 31,
          "method": "bindServerWithRetry",
          "lines": 77,
          "statements": 26,
          "complexity": 10,
          "depth": 4,
          "severity": "HIGH",
          "issues": ["Port retry logic", "Promise handling", "Error recovery"]
        },
        {
          "line": 1288,
          "method": "detectDhcpOrStatic (max-depth violation)",
          "lines": 100,
          "statements": 53,
          "complexity": 26,
          "depth": 5,
          "severity": "CRITICAL",
          "issues": [
            "5-level nesting (max allowed: 4)",
            "Multiple nested if/else chains",
            "Network detection logic mixed"
          ]
        },
        {
          "line": 1319,
          "method": "detectDhcpOrStatic (actual)",
          "lines": 103,
          "statements": 53,
          "complexity": 26,
          "depth": 5,
          "severity": "CRITICAL",
          "issues": [
            "Most complex method in file",
            "Platform-specific detection logic",
            "Multiple parsing concerns",
            "Excessive nesting"
          ]
        },
        {
          "line": 1448,
          "method": "getNetworkStatus",
          "lines": 59,
          "statements": 31,
          "complexity": 14,
          "depth": 4,
          "severity": "HIGH"
        },
        {
          "line": 1739,
          "method": "setupControlRoutes",
          "lines": 134,
          "statements": 68,
          "complexity": 18,
          "depth": 4,
          "severity": "CRITICAL",
          "issues": ["Route setup + handler definitions mixed", "Multiple nested route handlers"]
        },
        {
          "line": 1740,
          "method": "setupControlRoutes (nested arrow)",
          "lines": 80,
          "statements": 40,
          "complexity": 15,
          "severity": "HIGH",
          "issues": ["Deeply nested async arrow function"]
        },
        {
          "line": 1840,
          "method": "setupControlRoutes (nested)",
          "lines": 52,
          "statements": 25,
          "severity": "MEDIUM"
        },
        {
          "line": 2150,
          "method": "handleNetworkStatus",
          "lines": 55,
          "statements": 26,
          "complexity": 19,
          "depth": 4,
          "severity": "HIGH",
          "issues": ["Network status processing logic"]
        },
        {
          "line": 2220,
          "method": "handleNetworkTest",
          "lines": 114,
          "statements": 68,
          "complexity": 20,
          "depth": 5,
          "severity": "CRITICAL",
          "issues": [
            "5-level max-depth violation",
            "Ping/network test logic",
            "Multiple test case handling"
          ]
        },
        {
          "line": 2324,
          "method": "handleQuickServiceAction",
          "lines": 57,
          "statements": 28,
          "severity": "MEDIUM",
          "unused_variable": "name"
        },
        {
          "line": 2580,
          "method": "setupServiceHandlers",
          "lines": 70,
          "statements": 35,
          "severity": "HIGH"
        },
        {
          "line": 2581,
          "method": "setupServiceHandlers (nested)",
          "lines": 59,
          "statements": 30,
          "severity": "HIGH"
        },
        {
          "line": 2661,
          "method": "handleDiscordStatus",
          "lines": 52,
          "statements": 24,
          "severity": "MEDIUM"
        },
        {
          "line": 2798,
          "method": "handleQuickServiceAction (duplicate?)",
          "lines": 57,
          "statements": 27,
          "severity": "MEDIUM"
        },
        {
          "line": 2887,
          "method": "getMetrics",
          "lines": 93,
          "statements": 48,
          "complexity": 16,
          "severity": "HIGH",
          "issues": ["Metric aggregation and formatting"]
        }
      ],
      "refactoringApproach": "Multi-Strategy Decomposition",
      "strategies": {
        "nestingReduction": {
          "target": ["detectDhcpOrStatic", "handleNetworkTest"],
          "approach": "Extract inner logic to private helper methods",
          "example": "detectDhcpOrStatic → _detectDhcpMethod() + _detectStaticMethod() + _selectMethod()"
        },
        "methodExtraction": {
          "target": ["setupControlRoutes", "setupServiceHandlers"],
          "approach": "Break setup into focused private methods per concern",
          "example": "setupControlRoutes → _setupMetricsRoute() + _setupNetworkRoute() + _setupServiceRoute()"
        },
        "logicExtraction": {
          "target": ["getMetrics", "handleNetworkStatus"],
          "approach": "Extract data transformation to separate methods",
          "example": "getMetrics → _aggregateMetrics() + _formatMetrics() + _calculateUptime()"
        }
      }
    },
    "logger": {
      "category": "Console output in library code (15 violations)",
      "file": "src/utils/logger.js",
      "violations": [
        {
          "line": 34,
          "type": "console.error in _ensureLogDirectory",
          "issue": "Error output to stdout instead of silent failure",
          "severity": "MEDIUM"
        },
        {
          "line": 67,
          "type": "console.error in _writeToFile",
          "issue": "Redundant with file logging",
          "severity": "MEDIUM"
        },
        {
          "line": 101,
          "type": "console.error in _rotateLogFileIfNeeded",
          "issue": "Non-fatal error should be silent",
          "severity": "MEDIUM"
        },
        {
          "line": 122,
          "type": "console.log in debug()",
          "issue": "Should use logger.debug(), not console.log",
          "severity": "HIGH"
        },
        {
          "line": 126,
          "type": "console.log in debug() data logging",
          "issue": "Mixing console and file logging",
          "severity": "HIGH"
        },
        {
          "line": 152,
          "type": "console.log in info()",
          "issue": "Redundant console output",
          "severity": "HIGH"
        },
        {
          "line": 153,
          "type": "console.log in info() data",
          "issue": "Mixing console and file logging",
          "severity": "HIGH"
        },
        {
          "line": 169,
          "type": "console.warn in warn()",
          "issue": "Should use logger only",
          "severity": "HIGH"
        },
        {
          "line": 170,
          "type": "console.warn in warn() data",
          "issue": "Mixing console and file logging",
          "severity": "HIGH"
        },
        {
          "line": 186,
          "type": "console.error in error()",
          "issue": "Redundant with file logging",
          "severity": "HIGH"
        },
        {
          "line": 201,
          "type": "console.error for API errors",
          "issue": "Debug info exposed to console",
          "severity": "MEDIUM"
        },
        {
          "line": 208,
          "type": "console.error for no response",
          "issue": "Should only log to file",
          "severity": "MEDIUM"
        },
        {
          "line": 211,
          "type": "console.error for data objects",
          "issue": "Unnecessary console output",
          "severity": "MEDIUM"
        },
        {
          "line": 220,
          "type": "console.error for message",
          "issue": "Duplicate error logging",
          "severity": "MEDIUM"
        },
        {
          "line": 221,
          "type": "console.error for stack trace",
          "issue": "Duplicate error logging",
          "severity": "MEDIUM"
        }
      ],
      "refactoringApproach": "Silent Library Logging",
      "principle": "Library code should NOT output to console - only to file/delegate",
      "pattern": {
        "before": "console.log/warn/error in library methods",
        "after": "Silent failure with only file logging or callback"
      }
    },
    "unusedVariables": {
      "category": "Unused variable warnings",
      "count": 7,
      "violations": [
        {
          "file": "__tests__/unit/index-uncovered-paths.test.js",
          "line": 1,
          "imports": ["Client", "GatewayIntentBits", "REST", "Routes"],
          "type": "unused mock imports",
          "severity": "LOW",
          "fix": "Remove unused imports or use prefix underscore"
        },
        {
          "file": "__tests__/unit/index.test.js",
          "line": 400,
          "variable": "reminderServiceMock",
          "type": "unused variable",
          "severity": "LOW"
        },
        {
          "file": "__tests__/unit/index.test.js",
          "line": 401,
          "variable": "localMockClientReadyHandler",
          "type": "unused variable",
          "severity": "LOW"
        },
        {
          "file": "__tests__/unit/index.test.js",
          "line": 402,
          "variable": "testLoggerMock",
          "type": "unused variable",
          "severity": "LOW"
        },
        {
          "file": "src/services/web-dashboard.js",
          "line": 1848,
          "variable": "stderr",
          "type": "unused destructured variable",
          "severity": "LOW"
        },
        {
          "file": "src/services/web-dashboard.js",
          "line": 2156,
          "variable": "gateway",
          "type": "unused destructured variable",
          "severity": "LOW"
        },
        {
          "file": "src/services/web-dashboard.js",
          "line": 2324,
          "variable": "name",
          "type": "unused destructured variable",
          "severity": "LOW"
        }
      ],
      "refactoringApproach": "Prefix with underscore or remove"
    },
    "additionalErrorsDetail": {
      "piDetectorJs": {
        "file": "src/utils/pi-detector.js (referenced in logger.js)",
        "line": 360,
        "method": "createEnvOverrides",
        "lines": 53,
        "complexity": 16,
        "severity": "MEDIUM",
        "issues": ["Complexity too high for environment variable setup"]
      }
    }
  },
  "refactoringStrategy": {
    "phase1_TestFileRefactoring": {
      "priority": 1,
      "estimatedHours": 6,
      "impactScore": 8,
      "effortScore": 6,
      "roi": 1.33,
      "targetFiles": [
        "__tests__/unit/services/perplexity-secure-comprehensive.test.js",
        "__tests__/unit/services/database.test.js",
        "__tests__/unit/services/reminder-service.test.js"
      ],
      "approach": {
        "strategy": "Nested Describe Block Restructuring",
        "technique": "Logical test grouping using nested describe() blocks",
        "guidelines": [
          "Keep all tests in same file (no file splitting)",
          "Group by concern: _safeGetHeader tests, cache tests, response processing tests",
          "Create shared test factories in beforeEach hooks",
          "Extract repetitive mock setup to helper functions",
          "Limit nested describe depth to 2-3 levels",
          "Ensure each describe block ≤ 150 lines"
        ]
      },
      "beforeExample": {
        "structure": "describe('Service', () => { HUGE BLOCK 681 LINES })"
      },
      "afterExample": {
        "structure": "describe('Service', () => { describe('_safeGetHeader', () => {...}); describe('caching', () => {...}); describe('response processing', () => {...}); })"
      },
      "specifics": {
        "perplexitySecureComprehensive": {
          "totalLines": 681,
          "targetGroups": [
            {"name": "_safeGetHeader method", "testCount": 8, "expectedLines": 90},
            {"name": "caching functionality", "testCount": 15, "expectedLines": 140},
            {"name": "response processing", "testCount": 12, "expectedLines": 120},
            {"name": "error handling", "testCount": 10, "expectedLines": 100},
            {"name": "private methods", "testCount": 15, "expectedLines": 150}
          ],
          "extractedHelpers": [
            "createMockPerplexityService()",
            "createMockResponse(type, status)",
            "createMockCache(stats)",
            "setupDefaultMocks()"
          ]
        },
        "databaseService": {
          "totalLines": 222,
          "targetGroups": [
            {"name": "User management", "methods": ["ensureUserExists", "updateUserStats"], "expectedLines": 60},
            {"name": "Message storage", "methods": ["addUserMessage", "addBotResponse"], "expectedLines": 50},
            {"name": "Conversation history", "methods": ["getConversationHistory", "clearOldMessages"], "expectedLines": 60},
            {"name": "Reminders (basic)", "methods": ["getActiveReminders"], "expectedLines": 40}
          ]
        },
        "reminderService": {
          "totalLines": 308,
          "targetGroups": [
            {"name": "EventEmitter initialization", "expectedLines": 40},
            {"name": "Timer management", "expectedLines": 80},
            {"name": "Reminder scheduling", "expectedLines": 90},
            {"name": "Event emission", "expectedLines": 60},
            {"name": "Edge cases", "expectedLines": 38}
          ]
        }
      }
    },
    "phase2_CommandsRefactoring": {
      "priority": 2,
      "estimatedHours": 4,
      "impactScore": 7,
      "effortScore": 5,
      "roi": 1.4,
      "targetFile": "src/commands/index.js",
      "approach": {
        "strategy": "Method Extraction with Clear Separation of Concerns",
        "pattern": "Execute = Orchestrator; Private helpers = Specific concerns",
        "refactoringSteps": [
          "Step 1: Extract embed creation → _buildXxxEmbed(data) private method",
          "Step 2: Extract data fetching → _fetchXxxData() private method",
          "Step 3: Extract error handling → _handleXxxError(error) private method",
          "Step 4: Simplify execute() to orchestrate helpers",
          "Step 5: Add JSDoc to private methods"
        ]
      },
      "commandBreakdown": {
        "analytics": {
          "method": "execute (line 261, 98 lines)",
          "challenges": ["8+ embed fields", "Multiple data sources", "Status calculations"],
          "extraction": {
            "_buildAnalyticsEmbed": "Creates embed with all fields",
            "_fetchAnalyticsData": "Aggregates stats + server data",
            "_formatAnalyticsSection": "Formats field sections"
          },
          "expectedLines": "Execute: 12-15 lines; Helpers: 25-30 each"
        },
        "dashboard": {
          "method": "execute (line 385, 87 lines)",
          "challenges": ["3-way ternary for color", "Real-time status", "6+ fields"],
          "extraction": {
            "_buildDashboardEmbed": "Creates embed with dynamic color",
            "_fetchDashboardData": "Gathers system/server data",
            "_selectStatusColor": "Determines embed color based on status"
          },
          "expectedLines": "Execute: 10-12 lines; Helpers: 20-25 each"
        },
        "resources": {
          "method": "execute (line 491, 61 lines)",
          "challenges": ["Conditional coloring", "Multiple optimizations"],
          "extraction": {
            "_buildResourcesEmbed": "Creates embed",
            "_fetchResourceData": "Gathers resource stats"
          }
        }
      },
      "codePattern": {
        "before": "Monolithic execute() with embed + data + error handling",
        "after": "execute() calls: deferReply → fetchData → buildEmbed → reply/error"
      }
    },
    "phase3_WebDashboardRefactoring": {
      "priority": 3,
      "estimatedHours": 5,
      "impactScore": 9,
      "effortScore": 7,
      "roi": 1.29,
      "targetFile": "src/services/web-dashboard.js",
      "approach": {
        "strategy": "Multi-layered decomposition targeting nesting & complexity",
        "criticalMethod": "detectDhcpOrStatic (103 lines, complexity 26, depth 5)",
        "techniques": [
          "Extract nested conditionals to separate private methods",
          "Create helper methods for platform-specific logic",
          "Use Guard clauses to reduce nesting",
          "Create data transformation layer for network detection"
        ]
      },
      "violations": [
        {
          "method": "detectDhcpOrStatic",
          "type": "MAX-DEPTH VIOLATION",
          "currentDepth": 5,
          "maxAllowed": 4,
          "currentComplexity": 26,
          "targetComplexity": 12,
          "refactoring": {
            "step1": "Extract platform detection → _determinePlatform()",
            "step2": "Extract DHCP detection → _detectDhcpMethod(platform)",
            "step3": "Extract Static detection → _detectStaticMethod(platform)",
            "step4": "Create _selectDetectionMethod(dhcpResult, staticResult)",
            "expectedLinesDelta": "103 → 25 (main) + 15 + 15 + 12 (helpers)"
          }
        },
        {
          "method": "handleNetworkTest",
          "type": "COMBINED VIOLATIONS",
          "issues": ["114 lines", "68 statements", "complexity 20", "depth 5"],
          "refactoring": {
            "extractNetwork": "_performNetworkTest() - actual ping logic",
            "extractValidation": "_validateNetworkTestInput()",
            "extractFormatting": "_formatNetworkTestResults()",
            "expectedResult": "Main: 20 lines; Helpers: 25+25+20"
          }
        },
        {
          "method": "setupControlRoutes",
          "type": "ROUTE HANDLER NESTING",
          "lines": 134,
          "refactoring": {
            "splitRoutes": [
              "_setupMetricsRoute()",
              "_setupNetworkRoute()",
              "_setupServiceRoute()",
              "_setupDiagnosticsRoute()"
            ],
            "expectedResult": "Main: 15 lines; Each route handler: 20-30 lines"
          }
        },
        {
          "method": "getMetrics",
          "type": "DATA TRANSFORMATION",
          "lines": 93,
          "complexity": 16,
          "refactoring": {
            "extractMetrics": [
              "_aggregateSystemMetrics()",
              "_formatMemoryMetrics()",
              "_calculatePerformanceMetrics()",
              "_buildMetricsResponse()"
            ]
          }
        }
      ],
      "decompositionOrder": [
        "detectDhcpOrStatic (CRITICAL - max depth violation)",
        "handleNetworkTest (CRITICAL - max depth + high complexity)",
        "setupControlRoutes (HIGH - nested handlers)",
        "getMetrics (HIGH - complex transformation)",
        "handleNetworkStatus, handleDiscordStatus, getMetrics"
      ]
    },
    "phase4_LoggerRefactoring": {
      "priority": 4,
      "estimatedHours": 2,
      "impactScore": 6,
      "effortScore": 3,
      "roi": 2.0,
      "targetFile": "src/utils/logger.js",
      "approach": {
        "strategy": "Remove console output - library code should NOT write to stdout",
        "principle": "Libraries are silent; applications handle output display",
        "changes": [
          "Remove all console.log/warn/error calls",
          "Keep file-based logging only",
          "Move console output to bot orchestrator (index.js) for selected logs",
          "Use environment variable to enable debug output if needed"
        ]
      },
      "violations": {
        "batchRemoval": {
          "in_ensureLogDirectory": "console.error → silent logger.debug()",
          "in_writeToFile": "console.error → silent logger.debug()",
          "in_rotateLogFileIfNeeded": "console.error → silent logger.debug()",
          "in_debug": "console.log REMOVAL → file only",
          "in_info": "console.log REMOVAL → file only",
          "in_warn": "console.warn REMOVAL → file only",
          "in_error": "console.error REMOVAL → file only (except for API debug)"
        },
        "apiErrorLogging": {
          "current": "console.error for API response details",
          "change": "Log to file only, or return structured error for app-level display"
        }
      },
      "implementationPattern": {
        "before": "console.error('Error:', error); logger._writeToFile(...);",
        "after": "this._writeToFile(formattedMessage); // silent library"
      }
    },
    "phase5_UnusedVariablesCleanup": {
      "priority": 5,
      "estimatedHours": 1,
      "impactScore": 3,
      "effortScore": 2,
      "roi": 1.5,
      "approach": {
        "strategy": "Remove or prefix unused imports/variables",
        "options": [
          "Delete if unused and not needed for future",
          "Prefix with underscore (_) if intentionally unused (e.g., unused mock parameters)",
          "Check if import is needed for type checking only (keep for clarity)"
        ]
      },
      "details": {
        "testUnusedImports": {
          "fix": "Check if unused for mock registration - remove if not needed",
          "example": "jest.mock('discord.js', () => ({ Client: jest.fn(...), /* keep only what's used */ }))"
        },
        "testUnusedVars": {
          "fix": "Remove from destructuring or prefix with underscore if intentional",
          "example": "const { reminderServiceMock, _unusedVar } = require(...); // or just remove"
        },
        "dashboardUnusedVars": {
          "line1848": "const { stderr, ... } = spawn(...); → const { _stderr, ... }",
          "line2156": "gateway unused in handler → prefix or remove",
          "line2324": "name destructured but unused → check context"
        }
      }
    }
  },
  "prioritizationMatrix": {
    "highestImpactEffort": [
      {
        "phase": "Phase 3 - Web Dashboard",
        "impact": 9,
        "effort": 7,
        "ratio": 1.29,
        "justification": "MOST complex file; multiple CRITICAL violations (max-depth); touches core functionality"
      },
      {
        "phase": "Phase 1 - Test Files",
        "impact": 8,
        "effort": 6,
        "ratio": 1.33,
        "justification": "9 files × 200+ lines each; improves test maintainability; same-file refactoring"
      },
      {
        "phase": "Phase 2 - Commands",
        "impact": 7,
        "effort": 5,
        "ratio": 1.4,
        "justification": "User-facing commands; clear pattern application; good learning opportunity"
      },
      {
        "phase": "Phase 4 - Logger",
        "impact": 6,
        "effort": 3,
        "ratio": 2.0,
        "justification": "Best ROI; high effort ratio; quick wins; improves code library quality"
      },
      {
        "phase": "Phase 5 - Unused Variables",
        "impact": 3,
        "effort": 2,
        "ratio": 1.5,
        "justification": "Lowest priority; quick cleanup; mainly cosmetic"
      }
    ],
    "recommendedExecutionOrder": [
      "Phase 4 (Logger) - Quick wins to build momentum",
      "Phase 2 (Commands) - Clear pattern, moderate scope",
      "Phase 1 (Tests) - Largest scope but well-structured",
      "Phase 3 (Web Dashboard) - Most complex; tackle last when patterns established",
      "Phase 5 (Unused Variables) - Final cleanup pass"
    ],
    "alternativeOrder": [
      "If targeting test coverage: Phase 1 → Phase 3 → Phase 2",
      "If targeting complexity reduction: Phase 3 → Phase 2 → Phase 4",
      "If targeting quick quality gains: Phase 4 → Phase 5 → Phase 2"
    ]
  },
  "codeExamples": {
    "testRefactoring": {
      "beforePattern": {
        "file": "__tests__/unit/services/perplexity-secure-comprehensive.test.js",
        "structure": "describe('Service', () => { test1; test2; ...; test50; }); // 681 lines",
        "problems": [
          "Horizontal scrolling required to navigate",
          "Hard to find specific tests",
          "Mock setup scattered throughout",
          "Difficult to run subset of tests"
        ]
      },
      "afterPattern": {
        "file": "__tests__/unit/services/perplexity-secure-comprehensive.test.js",
        "structure": "describe('Service', () => { describe('_safeGetHeader', () => { test1-8 }); describe('caching', () => { test9-24 }); ... }); // Still same file",
        "benefits": [
          "Logical grouping",
          "Can run: --testNamePattern '_safeGetHeader'",
          "Shared setup in each nested describe",
          "Better error reporting: 'Service > _safeGetHeader > should return empty string'"
        ]
      },
      "implementationSteps": {
        "step1": "Identify logical test groups: _safeGetHeader (8 tests), caching (15 tests), etc.",
        "step2": "Create nested describe blocks for each group",
        "step3": "Move setup/teardown inside each describe's beforeEach/afterEach",
        "step4": "Extract shared setup to testHelpers.js",
        "step5": "Keep related test utilities near the describe blocks"
      },
      "codeSnippet": {
        "before": "describe('PerplexitySecure Service', () => { it('_safeGetHeader with null'); it('_safeGetHeader with undefined'); ... 679 more lines })",
        "after": "describe('PerplexitySecure Service', () => { describe('_safeGetHeader', () => { beforeEach(() => { /* setup */ }); it('should return empty string for null'); it('should return empty string for undefined'); }); describe('caching', () => { /* 15 cache tests */ }); })"
      }
    },
    "commandsRefactoring": {
      "beforePattern": {
        "file": "src/commands/index.js",
        "method": "analytics execute()",
        "lines": 98,
        "code": "async execute(interaction) { await interaction.deferReply(); const serverId = ...; const guild = ...; /* fetch data */ const analyticsData = { /* 10 lines */ }; const embed = { color: 0x5865f2, title: '...', fields: [ /* 8 fields × 5 lines */ ] }; return interaction.editReply(...); } catch(error) { /* error handling */ }"
      },
      "afterPattern": {
        "file": "src/commands/index.js",
        "method": "analytics execute()",
        "lines": 12,
        "code": "async execute(interaction) { try { await interaction.deferReply(); const data = await this._fetchAnalyticsData(interaction.guild); const embed = this._buildAnalyticsEmbed(data); return interaction.editReply({ embeds: [embed] }); } catch(error) { return this._handleAnalyticsError(error, interaction); } }",
        "extracted": [
          "_fetchAnalyticsData(guild): Returns { humanMembers, botCount, stats }",
          "_buildAnalyticsEmbed(data): Builds 8-field embed",
          "_handleAnalyticsError(error, interaction): Returns error response"
        ]
      },
      "pattern": {
        "orchestrator": "execute() - 8-12 lines - calls helpers in sequence",
        "dataFetch": "_fetchXxxData(guild/interaction) - 15-25 lines - gathers data",
        "embedding": "_buildXxxEmbed(data) - 20-30 lines - creates embed",
        "error": "_handleXxxError(error, interaction) - 8-12 lines - formats error"
      }
    },
    "webDashboardRefactoring": {
      "beforePattern": {
        "method": "detectDhcpOrStatic()",
        "lines": 103,
        "complexity": 26,
        "depth": 5,
        "pseudocode": "if (platform === 'linux') { if (check dhcp) { if (parse response) { if (validate) { return result } } } else if (check static) { ... } } else if (platform === 'darwin') { ... }",
        "problem": "5-level nesting exceeds max allowed 4-level depth"
      },
      "afterPattern": {
        "method": "detectDhcpOrStatic()",
        "lines": 25,
        "complexity": 8,
        "depth": 2,
        "code": "const platform = this._determinePlatform(); const dhcpResult = this._detectDhcpMethod(platform); const staticResult = this._detectStaticMethod(platform); return this._selectDetectionMethod(dhcpResult, staticResult);",
        "extracted": [
          "_determinePlatform() - detects OS",
          "_detectDhcpMethod(platform) - DHCP-specific logic (depth 3)",
          "_detectStaticMethod(platform) - Static-specific logic (depth 3)",
          "_selectDetectionMethod(dhcp, static) - choose best result (depth 1)"
        ]
      },
      "guardClausePattern": {
        "before": "if (condition1) { if (condition2) { if (condition3) { // do work } } }",
        "after": "if (!condition1) return null; if (!condition2) return null; if (!condition3) return null; // do work"
      }
    },
    "loggerRefactoring": {
      "beforePattern": {
        "file": "src/utils/logger.js",
        "method": "debug()",
        "code": "debug(message, ...dataArgs) { if (this._getLogLevel() <= this.levels.DEBUG) { const msg = this._formatMessage('DEBUG', message); console.log(msg); dataArgs.forEach(d => console.log(d)); this._writeToFile(msg); dataArgs.forEach(d => this._writeToFile(JSON.stringify(d))); } }",
        "problems": ["console.log output", "Mixing stdout and file", "Visible to users"]
      },
      "afterPattern": {
        "file": "src/utils/logger.js",
        "method": "debug()",
        "code": "debug(message, ...dataArgs) { if (this._getLogLevel() <= this.levels.DEBUG) { const msg = this._formatMessage('DEBUG', message); this._writeToFile(msg); dataArgs.forEach(d => this._writeToFile(JSON.stringify(d))); } }",
        "benefits": ["Silent library operation", "File logging only", "Cleaner output"]
      },
      "principle": "Libraries should never write to stdout/stderr - they're silent utilities that delegate to their caller for display concerns"
    },
    "unusedVariablesRefactoring": {
      "testCase": {
        "before": "const { reminderServiceMock, localMockClientReadyHandler, testLoggerMock } = setupMocks(); // These are declared but never used",
        "after": "const { _reminderServiceMock, _localMockClientReadyHandler, _testLoggerMock } = setupMocks(); // OR remove completely if not needed"
      },
      "webDashboard": {
        "before": "const { stderr, stdout } = spawn(...); // stderr is never used",
        "after": "const { stdout } = spawn(...); // OR const { _stderr, stdout } = spawn(...);"
      }
    }
  },
  "testingStrategy": {
    "validateRefactoring": {
      "tests_still_pass": "npm test should pass 100%",
      "coverage_maintained": "Coverage ≥ current levels",
      "complexity_reduced": "Verify with quality:check",
      "depth_fixed": "Max-depth violations resolved"
    },
    "incrementalApproach": {
      "step1": "Fix Phase 4 (Logger) - validate with tests",
      "step2": "Refactor Phase 5 (Unused) - visual inspection",
      "step3": "Extract Phase 2 (Commands) - test each command",
      "step4": "Restructure Phase 1 (Tests) - test still passes",
      "step5": "Decompose Phase 3 (Dashboard) - integration tests verify"
    }
  },
  "successCriteria": {
    "quantitative": {
      "violations_resolved": "64 → 0",
      "max_function_lines": "630 → <50 (test functions) <100 (service methods)",
      "max_complexity": "26 → <15",
      "max_depth": "5 → ≤4",
      "console_statements": "15 → 0 (in logger)"
    },
    "qualitative": {
      "readability": "Each function/method has single clear purpose",
      "maintainability": "Easier to locate and modify specific functionality",
      "testability": "Test structure mirrors code structure",
      "debuggability": "Error stack traces point to focused methods"
    }
  },
  "estimatedTimeline": {
    "total_hours": 18,
    "phase_breakdown": {
      "phase4_logger": {"hours": 2, "start_day": 1, "end_day": 1},
      "phase5_unused": {"hours": 1, "start_day": 1, "end_day": 1},
      "phase2_commands": {"hours": 4, "start_day": 2, "end_day": 2},
      "phase1_tests": {"hours": 6, "start_day": 3, "end_day": 5},
      "phase3_dashboard": {"hours": 5, "start_day": 5, "end_day": 7}
    },
    "testing_buffer": "Days 7-8: Comprehensive testing & validation"
  },
  "toolsAndAutomation": {
    "analyzers": ["npm run quality:check", "eslint with max-depth/max-lines rules"],
    "testing": ["npm test", "npm run test:critical:ci"],
    "verification": ["Check .quality metrics", "Coverage reports", "ESLint output"]
  }
}
