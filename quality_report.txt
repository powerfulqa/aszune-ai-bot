
> aszuneai@1.9.0 quality:check
> npm run test:critical:ci


> aszuneai@1.9.0 test:critical:ci
> jest --config=jest.critical-coverage.config.js --coverage --silent --passWithNoTests --ci

FAIL __tests__/unit/services/perplexity-secure-comprehensive.test.js
  PerplexitySecure Service - Comprehensive Coverage
    _safeGetHeader method
      âˆš should return empty string for null headers (3 ms)
      âˆš should return empty string for undefined headers
      âˆš should return empty string for null key
      âˆš should get header using Headers.get() method (1 ms)
      âˆš should fall back to object property access (1 ms)
      âˆš should check lowercase header names
      âˆš should check uppercase header names
      âˆš should handle Headers.get() throwing error (1 ms)
      âˆš should handle non-object headers
      âˆš should handle function headers (1 ms)
    _shouldUseCache method
      âˆš should return false when caching is explicitly disabled
      âˆš should return true when in test environment (1 ms)
      âˆš should return true when cache is enabled and caching not disabled
    _buildRequestPayload method
      âˆš should build basic request payload with defaults (1 ms)
      âˆš should use custom options when provided (1 ms)
      âˆš should handle streaming when PI optimizations enabled
      âˆš should not enable streaming in low CPU mode (1 ms)
    _getPiOptimizationSettings method
      âˆš should return default settings when PI_OPTIMIZATIONS is not configured (4 ms)
      âˆš should return settings from config when available
      âˆš should handle config access errors gracefully (3 ms)
    _handleApiResponse method
      âˆš should throw error for null response (51 ms)
      âˆš should throw error for undefined response (1 ms)
      âˆš should handle error status codes
      âˆš should handle response without body (1 ms)
      âˆš should handle body without json method
      âˆš should handle JSON parsing errors (1 ms)
      âˆš should handle invalid response object (1 ms)
      âˆš should handle missing choices array (1 ms)
      âˆš should handle invalid choice structure
      âˆš should handle missing message field (1 ms)
      âˆš should return valid response data
    _handleErrorResponse method
      âˆš should handle error response with text body (1 ms)
      âˆš should handle error response without body
      âˆš should handle body text error (1 ms)
      âˆš should handle long error messages
    _extractResponseContent method
      âˆš should extract content from message.content
      âˆš should extract content from choice.content
      âˆš should handle empty response (4 ms)
      âˆš should handle empty choices (1 ms)
      âˆš should return default message for invalid structure (1 ms)
    _generateErrorMessage method
      âˆš should return rate limit message for 429 status (1 ms)
      âˆš should return service unavailable message for 5xx status
      âˆš should return network error message for network errors
      âˆš should return empty response message for empty response errors (1 ms)
      âˆš should return unexpected format message for invalid errors
      âˆš should return original error message for unknown errors (1 ms)
    _isRetryableError method
      âˆš should return false for null error
      âˆš should return false for error without message (1 ms)
      âˆš should return true for temporary errors
      âˆš should return true for network errors
      âˆš should return true for 429 errors (1 ms)
      âˆš should return false for permanent errors
      âˆš should return false for invalid errors
      âˆš should return false for unauthorized errors (1 ms)
      âˆš should return false for forbidden errors
      âˆš should return false for unknown errors by default (1 ms)
    _getCacheConfiguration method
      âˆš should return default config when PI_OPTIMIZATIONS not configured (4 ms)
      âˆš should return cache config when PI optimizations enabled (1 ms)
      âˆš should handle config access errors (4 ms)
    _formatCacheEntry method
      âˆš should format string entry with timestamp (1 ms)
      âˆš should preserve existing object entry with timestamp
      âˆš should add timestamp to object entry without one (1 ms)
      âˆš should handle null entry
    _generateCacheKey method
      âˆš should generate consistent cache key for same history (1 ms)
      âˆš should generate different keys for different history
    generateTextSummary method
      âˆš should generate text summary with correct options (2 ms)
      âˆš should handle text summary errors (3 ms)
    getCacheStats method
      âˆš should return cache stats when available (1 ms)
      Ã— should return error stats when cache throws (2 ms)
      Ã— should handle missing cache gracefully
    shutdown method
      âˆš should clear all active intervals (2 ms)
      âˆš should handle shutdown when no intervals exist (1 ms)

  â— PerplexitySecure Service - Comprehensive Coverage â€º getCacheStats method â€º should return error stats when cache throws

    expect(received).toBeDefined()

    Received: undefined

    [0m [90m 772 |[39m       [36mconst[39m result [33m=[39m perplexityService[33m.[39mgetCacheStats()[33m;[39m
     [90m 773 |[39m       expect(result[33m.[39mhits)[33m.[39mtoBe([35m0[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 774 |[39m       expect(result[33m.[39merror)[33m.[39mtoBeDefined()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 775 |[39m       expect(result[33m.[39merror)[33m.[39mtoContain([32m'Please try again later'[39m)[33m;[39m
     [90m 776 |[39m     })[33m;[39m
     [90m 777 |[39m[0m

      at Object.toBeDefined (__tests__/unit/services/perplexity-secure-comprehensive.test.js:774:28)

  â— PerplexitySecure Service - Comprehensive Coverage â€º getCacheStats method â€º should handle missing cache gracefully

    expect(received).toBeDefined()

    Received: undefined

    [0m [90m 782 |[39m       [36mconst[39m result [33m=[39m perplexityService[33m.[39mgetCacheStats()[33m;[39m
     [90m 783 |[39m       expect(result[33m.[39mhits)[33m.[39mtoBe([35m0[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 784 |[39m       expect(result[33m.[39merror)[33m.[39mtoBeDefined()[33m;[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 785 |[39m     })[33m;[39m
     [90m 786 |[39m   })[33m;[39m
     [90m 787 |[39m[0m

      at Object.toBeDefined (__tests__/unit/services/perplexity-secure-comprehensive.test.js:784:28)

FAIL __tests__/unit/services/database.test.js
  DatabaseService
    constructor
      âˆš should initialize without accessing config (2 ms)
    getDb
      âˆš should initialize database on first call and access config (2 ms)
      âˆš should return existing db on subsequent calls (1 ms)
      âˆš should throw error on database initialization failure (30 ms)
    initTables
      âˆš should create user_stats and user_messages tables (1 ms)
      âˆš should throw error on table creation failure (1 ms)
    getUserStats
      âˆš should return user stats for existing user (1 ms)
      âˆš should return default stats for non-existing user (1 ms)
      Ã— should throw error on query failure (2 ms)
    updateUserStats
      âˆš should update user stats correctly
      âˆš should handle missing updates gracefully
      âˆš should throw error on update failure (1 ms)
    getUserMessages
      âˆš should return last 10 messages for user (1 ms)
      âˆš should return empty array for user with no messages
      âˆš should throw error on query failure (1 ms)
    addUserMessage
      âˆš should add message to database
      Ã— should throw error on insert failure
    clearUserData
      âˆš should delete all user data (1 ms)
      Ã— should throw error on delete failure (1 ms)
    close
      âˆš should close database connection (1 ms)
      âˆš should handle close when db is not initialized
      â—‹ skipped should throw error on close failure

  â— DatabaseService â€º getUserStats â€º should throw error on query failure

    expect(received).toThrow(expected)

    Expected substring: "Failed to get user stats for 123: Query failed"

    Received function did not throw

    [0m [90m 150 |[39m       })[33m;[39m
     [90m 151 |[39m
    [31m[1m>[22m[39m[90m 152 |[39m       expect(() [33m=>[39m dbService[33m.[39mgetUserStats([32m'123'[39m))[33m.[39mtoThrow(
     [90m     |[39m                                                   [31m[1m^[22m[39m
     [90m 153 |[39m         [32m'Failed to get user stats for 123: Query failed'[39m
     [90m 154 |[39m       )[33m;[39m
     [90m 155 |[39m     })[33m;[39m[0m

      at Object.toThrow (__tests__/unit/services/database.test.js:152:51)

  â— DatabaseService â€º addUserMessage â€º should throw error on insert failure

    expect(received).toThrow(expected)

    Expected substring: "Failed to add user message for 123: Insert failed"

    Received function did not throw

    [0m [90m 253 |[39m       })[33m;[39m
     [90m 254 |[39m
    [31m[1m>[22m[39m[90m 255 |[39m       expect(() [33m=>[39m dbService[33m.[39maddUserMessage([32m'123'[39m[33m,[39m [32m'Hello world'[39m))[33m.[39mtoThrow(
     [90m     |[39m                                                                    [31m[1m^[22m[39m
     [90m 256 |[39m         [32m'Failed to add user message for 123: Insert failed'[39m
     [90m 257 |[39m       )[33m;[39m
     [90m 258 |[39m     })[33m;[39m[0m

      at Object.toThrow (__tests__/unit/services/database.test.js:255:68)

  â— DatabaseService â€º clearUserData â€º should throw error on delete failure

    expect(received).toThrow(expected)

    Expected substring: "Failed to clear user data for 123: Delete failed"

    Received function did not throw

    [0m [90m 273 |[39m       })[33m;[39m
     [90m 274 |[39m
    [31m[1m>[22m[39m[90m 275 |[39m       expect(() [33m=>[39m dbService[33m.[39mclearUserData([32m'123'[39m))[33m.[39mtoThrow(
     [90m     |[39m                                                    [31m[1m^[22m[39m
     [90m 276 |[39m         [32m'Failed to clear user data for 123: Delete failed'[39m
     [90m 277 |[39m       )[33m;[39m
     [90m 278 |[39m     })[33m;[39m[0m

      at Object.toThrow (__tests__/unit/services/database.test.js:275:52)

PASS __tests__/unit/text-commands-removal.test.js
  Text Commands Removal
    Migration to Slash Commands Only
      âˆš should verify that both handleTextCommand and handleSlashCommand exist (932 ms)
      âˆš should confirm all text commands have been migrated to slash commands (539 ms)
      âˆš should confirm reminder functionality exists as separate slash commands (502 ms)
      âˆš should verify help command shows updated syntax without text commands (582 ms)

PASS __tests__/unit/services/perplexity-secure-advanced.test.js
  PerplexitySecure Service - Advanced
    question caching
      âˆš should cache questions and return cached responses (16 ms)
      âˆš should not cache when caching is disabled (12 ms)
      âˆš should handle cache file read errors gracefully (11 ms)
      âˆš should handle cache file write errors gracefully (13 ms)
      âˆš should handle corrupted cache data (14 ms)
    file permission security
      âˆš should handle file permission errors gracefully (12 ms)
      âˆš should create cache directory with proper permissions (22 ms)
    retry mechanism
      âˆš should retry on temporary failures (1037 ms)
      âˆš should not retry on permanent failures (12 ms)
      âˆš should handle timeout errors (1023 ms)

PASS __tests__/unit/services/database-commands.test.js
  DatabaseService - Commands
    getCommandUsageStats
      âˆš should return default stats when no commands have been used (152 ms)
      âˆš should track command usage correctly (188 ms)
      âˆš should handle multiple command usages by same user (169 ms)
      âˆš should handle database errors gracefully (128 ms)
    trackCommandUsage
      âˆš should record command usage without throwing (138 ms)
      âˆš should handle database errors gracefully (136 ms)
      âˆš should handle empty command names (158 ms)
      âˆš should handle empty user IDs (142 ms)

PASS __tests__/unit/services/database-reminders.test.js
  DatabaseService - Reminders
    createReminder
      âˆš should create a reminder and return reminder object (136 ms)
      âˆš should handle database errors gracefully (1 ms)
    getActiveReminders
      âˆš should return empty array when no reminders exist (119 ms)
      âˆš should return active reminders for user (137 ms)
      âˆš should not return completed reminders (134 ms)
      âˆš should handle database errors gracefully (2 ms)
    getDueReminders
      âˆš should return empty array when no due reminders (118 ms)
      âˆš should return reminders that are due (256 ms)
      âˆš should handle database errors gracefully (1 ms)
    completeReminder
      âˆš should mark reminder as completed (136 ms)
      âˆš should return false for non-existent reminder (120 ms)
      âˆš should handle database errors gracefully (1 ms)
    cancelReminder
      âˆš should mark reminder as cancelled (143 ms)
      âˆš should return false for non-existent reminder (126 ms)
      âˆš should handle database errors gracefully (1 ms)
    getUserReminders
      âˆš should return all reminders for user regardless of status (142 ms)
      âˆš should return empty array for user with no reminders (122 ms)
      âˆš should handle database errors gracefully (1 ms)
    deleteReminder
      âˆš should permanently delete reminder (140 ms)
      âˆš should return false for non-existent reminder (121 ms)
      âˆš should handle database errors gracefully (1 ms)

PASS __tests__/unit/main-index-advanced.test.js
  Main Index - Advanced
    âˆš should handle bootWithOptimizations function (560 ms)
    âˆš should handle registerSlashCommands function (206 ms)
    âˆš should handle Pi optimization detection (1 ms)
    âˆš should handle enhanced cache initialization (1 ms)
    âˆš should handle perplexity service initialization (1 ms)
    âˆš should handle error scenarios gracefully (267 ms)
    âˆš should handle multiple imports without conflicts (199 ms)
    âˆš should handle environment variable changes (193 ms)
    âˆš should handle missing dependencies gracefully (187 ms)

PASS __tests__/unit/services/database-conversation.test.js
  DatabaseService - Conversation History
    getConversationHistory
      âˆš should return empty array for user with no conversation (124 ms)
      âˆš should return conversation history with proper roles (168 ms)
      âˆš should respect conversation limit (586 ms)
      âˆš should handle alternating user and bot messages correctly (226 ms)
      âˆš should handle database errors gracefully (126 ms)
      âˆš should return conversation history in chronological order (222 ms)

PASS __tests__/unit/commands-slash-data.test.js
  Commands - Slash Commands Data
    getSlashCommandsData
      âˆš should return an array of slash command data (5 ms)

Terminate batch job (Y/N)? Terminate batch job (Y/N)? Terminate batch job (Y/N)? Terminate batch job (Y/N)? Terminate batch job (Y/N)? 