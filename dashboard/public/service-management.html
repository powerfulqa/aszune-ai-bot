<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aszune AI Bot Dashboard - Service Management</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .demo-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
      }

      .services-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 20px;
        margin-top: 0;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .services-section h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .service-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .service-card {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        transition: border-color 0.3s;
      }

      .service-card:hover {
        border-color: #667eea;
      }

      .service-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
      }

      .service-name {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
      }

      .service-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-active {
        background: #1b5e20;
        color: #4caf50;
      }

      .status-active::before {
        content: '‚óè';
        animation: pulse 1s infinite;
      }

      .status-inactive {
        background: #3e2723;
        color: #ff7043;
      }

      .status-inactive::before {
        content: '‚óã';
      }

      .status-error {
        background: #4a235a;
        color: #ce93d8;
      }

      .status-error::before {
        content: '‚ö†';
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      .service-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
        font-size: 12px;
      }

      .info-row {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .info-label {
        color: #888;
        font-size: 11px;
        text-transform: uppercase;
      }

      .info-value {
        color: #2c3e50;
        font-weight: 500;
      }

      .service-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
      }

      .btn-start {
        background: #1b5e20;
        color: #4caf50;
        border: 1px solid #4caf50;
      }

      .btn-start:hover {
        background: #2e7d32;
      }

      .btn-stop {
        background: #4a235a;
        color: #ce93d8;
        border: 1px solid #ce93d8;
      }

      .btn-stop:hover {
        background: #6a1b9a;
      }

      .btn-restart {
        background: #1565c0;
        color: #42a5f5;
        border: 1px solid #42a5f5;
      }

      .btn-restart:hover {
        background: #1976d2;
      }

      .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .service-logs-preview {
        background: #f5f5f5;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        padding: 10px;
        font-size: 11px;
        font-family: 'Courier New', monospace;
        max-height: 150px;
        overflow-y: auto;
        color: #2c3e50;
      }

      .log-line {
        color: #888;
        line-height: 1.4;
        margin-bottom: 2px;
      }

      .log-line.error {
        color: #e57373;
      }

      .log-line.warn {
        color: #ffb74d;
      }

      .enabled-indicator {
        font-size: 11px;
        color: #888;
      }

      .enabled-indicator.yes {
        color: #4caf50;
      }

      .legend {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .legend-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .legend-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        font-size: 12px;
      }

      .legend-item {
        display: flex;
        gap: 8px;
      }

      .legend-icon {
        color: #2c3e50;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <!-- Header -->
      <header class="dashboard-header">
        <div class="header-left">
          <h1>Aszune AI Bot Dashboard</h1>
          <div class="version-info">
            <span class="version-badge" id="version-badge">
              <span class="version-text">v<span id="version-number">1.8.0</span></span>
              <span class="commit-text"
                >Commit:
                <a id="commit-link" href="#" target="_blank"
                  ><span id="commit-sha">unknown</span></a
                ></span
              >
            </span>
          </div>
        </div>
        <div class="header-right">
          <div class="control-buttons">
            <button
              id="git-pull-btn"
              class="control-btn git-pull-btn"
              title="Pull latest changes from GitHub"
            >
              <span class="btn-icon">‚¨áÔ∏è</span>
              <span class="btn-label">Git Pull</span>
            </button>
            <button id="restart-btn" class="control-btn restart-btn" title="Restart the bot">
              <span class="btn-icon">üîÑ</span>
              <span class="btn-label">Restart</span>
            </button>
          </div>
          <div class="status-indicator">
            <span class="status-dot connecting" id="status-dot"></span>
            <span id="status-text">Connecting...</span>
          </div>
        </div>
      </header>

      <!-- Top Navigation Bar for Features -->
      <nav class="dashboard-navbar">
        <div class="navbar-content">
          <a href="index.html" class="navbar-item navbar-home" title="System Dashboard">
            <span class="navbar-icon">üìä</span>
            <span class="navbar-label">Dashboard</span>
          </a>
          <a href="logs-viewer.html" class="navbar-item navbar-item-1" title="Real-Time Log Viewer">
            <span class="navbar-icon">üìã</span>
            <span class="navbar-label">Logs</span>
          </a>
          <a
            href="service-management.html"
            class="navbar-item navbar-item-2"
            title="Service Status & Management"
          >
            <span class="navbar-icon">üîß</span>
            <span class="navbar-label">Services</span>
          </a>
          <a
            href="config-editor.html"
            class="navbar-item navbar-item-3"
            title="Configuration Editor"
          >
            <span class="navbar-icon">‚öôÔ∏è</span>
            <span class="navbar-label">Config</span>
          </a>
          <a
            href="network-status.html"
            class="navbar-item navbar-item-5"
            title="Network & Connectivity Status"
          >
            <span class="navbar-icon">üåê</span>
            <span class="navbar-label">Network</span>
          </a>
          <a
            href="reminder-management.html"
            class="navbar-item navbar-item-7"
            title="Reminder Management Interface"
          >
            <span class="navbar-icon">‚è∞</span>
            <span class="navbar-label">Reminders</span>
          </a>
          <a href="database.html" class="navbar-item navbar-link" title="View Database Contents">
            <span class="navbar-icon">üíæ</span>
            <span class="navbar-label">Database</span>
          </a>
          <a href="error-logs.html" class="navbar-item navbar-link" title="View Error Logs">
            <span class="navbar-icon">‚ö†Ô∏è</span>
            <span class="navbar-label">Errors</span>
          </a>
        </div>
      </nav>

      <!-- Service Management Section -->
      <div class="services-section">
        <h2>üîß System Services Management</h2>

        <!-- Discord Connection Status Card -->
        <div
          class="discord-status-card"
          style="
            background: linear-gradient(135deg, #5865f2 0%, #404eed 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: white;
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
          "
        >
          <div style="display: flex; align-items: center; justify-content: space-between">
            <div style="display: flex; align-items: center; gap: 15px">
              <div style="font-size: 48px">üí¨</div>
              <div>
                <h3 style="margin: 0 0 8px 0; font-size: 1.3rem">Discord Connection</h3>
                <div id="discord-status-container">
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span
                      id="discord-status-dot"
                      class="status-dot connecting"
                      style="width: 12px; height: 12px"
                    ></span>
                    <span id="discord-status-text" style="font-size: 1rem; font-weight: 500"
                      >Checking...</span
                    >
                  </div>
                  <div
                    id="discord-status-details"
                    style="margin-top: 8px; font-size: 0.9rem; opacity: 0.9"
                  ></div>
                </div>
              </div>
            </div>
            <div
              id="discord-status-info"
              style="text-align: right; font-size: 0.85rem; opacity: 0.8"
            >
              <div id="discord-username">Bot: <span id="discord-bot-tag">-</span></div>
              <div id="discord-uptime">Uptime: <span id="discord-uptime-value">-</span></div>
            </div>
          </div>
        </div>

        <!-- Instance Tracking Status Card -->
        <div
          class="instance-tracking-card"
          style="
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
          "
        >
          <div style="display: flex; align-items: center; justify-content: space-between">
            <div style="display: flex; align-items: center; gap: 15px">
              <div style="font-size: 48px">üîç</div>
              <div>
                <h3 style="margin: 0 0 8px 0; font-size: 1.3rem">Instance Tracking</h3>
                <div id="tracking-status-container">
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span
                      id="tracking-status-dot"
                      class="status-dot connecting"
                      style="width: 12px; height: 12px"
                    ></span>
                    <span id="tracking-status-text" style="font-size: 1rem; font-weight: 500"
                      >Checking...</span
                    >
                  </div>
                  <div
                    id="tracking-status-details"
                    style="margin-top: 8px; font-size: 0.9rem; opacity: 0.9"
                  ></div>
                </div>
              </div>
            </div>
            <div
              id="tracking-status-info"
              style="text-align: right; font-size: 0.85rem; opacity: 0.8"
            >
              <div>Instance: <span id="tracking-instance-id">-</span></div>
              <div>Location: <span id="tracking-location">-</span></div>
              <div>IP: <span id="tracking-ip">-</span></div>
            </div>
          </div>

          <!-- Instance Tracking Sections -->
          <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px">
            <div 
              id="instances-toggle" 
              style="cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95rem"
              onclick="toggleInstancesList()"
            >
              <span id="instances-arrow">‚ñ∂</span>
              <span>View All Instances</span>
              <span id="instances-count" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem">0</span>
              <span id="instances-alert" style="display: none; color: #ff6b6b; font-weight: bold">‚ö†Ô∏è Unauthorized detected!</span>
            </div>
            
            <div id="instances-container" style="display: none; margin-top: 12px">
              <!-- Authorized Instances -->
              <div style="margin-bottom: 15px">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px">
                  <span style="font-size: 1.1rem">‚úÖ</span>
                  <span style="font-weight: 600">Authorized Instances</span>
                  <span id="authorized-count" style="background: rgba(34,197,94,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem">0</span>
                </div>
                <div id="authorized-list" style="max-height: 200px; overflow-y: auto">
                  <div style="font-size: 0.85rem; opacity: 0.7">Loading...</div>
                </div>
              </div>
              
              <!-- Unauthorized Instances -->
              <div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px">
                  <span style="font-size: 1.1rem">‚ö†Ô∏è</span>
                  <span style="font-weight: 600">Unauthorized Instances</span>
                  <span id="unauthorized-count" style="background: rgba(239,68,68,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem">0</span>
                </div>
                <div id="unauthorized-list" style="max-height: 200px; overflow-y: auto">
                  <div style="font-size: 0.85rem; opacity: 0.7">None detected</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="service-grid" id="services-grid">
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999">
            ‚è≥ Loading services from server...
          </div>
        </div>

        <!-- Legend -->
        <div class="legend">
          <div class="legend-title">Service Status Legend</div>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-icon">‚óè </span>
              <span>Active service running normally</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon">‚óã </span>
              <span>Service stopped</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon">‚ö† </span>
              <span>Service error or timeout</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon">‚úì </span>
              <span>Service enabled on boot</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon">‚úó </span>
              <span>Service disabled on boot</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px">
        <h3 style="margin-top: 0; color: #2c3e50">‚ö° Quick Actions</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button class="action-btn btn-restart" onclick="performQuickAction('restart-all')">
            üîÑ Restart All Services
          </button>
          <button class="action-btn btn-start" onclick="performQuickAction('start-all')">
            ‚ñ∂ Start All Services
          </button>
        </div>
        <div
          style="
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
          "
        >
          <small style="color: #856404">
            <strong>Note:</strong> These actions affect all PM2-managed processes. Use individual
            service controls above for specific services.
          </small>
        </div>
      </div>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="dashboard.js"></script>
    <script>
      function loadServices() {
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) {
          console.error('Dashboard socket not available');
          return;
        }

        dashboardSocket.emit('request_services', {}, (response) => {
          console.log('Services response:', response);
          if (response && response.services) {
            renderServices(response.services);
          } else {
            console.error('No services received from server', response);
          }
        });
      }

      function renderServices(services) {
        const grid = document.getElementById('services-grid');
        if (services.length === 0) {
          grid.innerHTML =
            '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">No services available</div>';
          return;
        }

        grid.innerHTML = services
          .map(
            (service) => `
                <div class="service-card">
                    <div class="service-header">
                        <span class="service-name">${service.icon} ${service.name}</span>
                        <div class="service-status">
                            <span class="status-badge status-${service.status === 'Active' ? 'active' : 'inactive'}">${service.status}</span>
                            <span class="enabled-indicator ${service.enabledOnBoot ? 'yes' : 'no'}">‚óè ${service.enabledOnBoot ? 'Enabled' : 'Disabled'} on boot</span>
                        </div>
                    </div>

                    <div class="service-info">
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value">${service.status}</span>
                        </div>
                        ${
                          service.uptime
                            ? `<div class="info-row">
                            <span class="info-label">Uptime</span>
                            <span class="info-value">${service.uptime}</span>
                        </div>`
                            : ''
                        }
                        ${
                          service.memory
                            ? `<div class="info-row">
                            <span class="info-label">Memory</span>
                            <span class="info-value">${service.memory}</span>
                        </div>`
                            : ''
                        }
                    </div>

                    <div class="service-actions">
                        ${
                          service.status === 'Running'
                            ? `<button class="action-btn btn-stop" onclick="performAction('${service.id}', 'stop')">‚èπ Stop</button>
                            <button class="action-btn btn-restart" onclick="performAction('${service.id}', 'restart')">üîÑ Restart</button>`
                            : `<button class="action-btn btn-start" onclick="performAction('${service.id}', 'start')">‚ñ∂ Start</button>`
                        }
                    </div>
                </div>
            `
          )
          .join('');
      }

      function performAction(serviceName, action) {
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) {
          console.error('Dashboard socket not available');
          return;
        }

        dashboardSocket.emit(
          'service_action',
          { serviceName: serviceName, action: action },
          (response) => {
            if (response && response.success) {
              alert(`Service ${action} successful`);
              loadServices(); // Reload service status
            } else {
              alert(`Failed to ${action} service: ` + (response?.error || 'Unknown error'));
            }
          }
        );
      }

      function performQuickAction(actionGroup) {
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) {
          console.error('Dashboard socket not available');
          return;
        }

        dashboardSocket.emit('quick_service_action', { group: actionGroup }, (response) => {
          if (response && response.success) {
            alert('Quick action completed successfully');
            loadServices(); // Reload service status
          } else {
            alert('Quick action failed: ' + (response?.error || 'Unknown error'));
          }
        });
      }

      function loadDiscordStatus() {
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) {
          console.error('Dashboard socket not available');
          return;
        }

        dashboardSocket.emit('request_discord_status', {}, (response) => {
          console.log('Discord status response:', response);

          const statusDot = document.getElementById('discord-status-dot');
          const statusText = document.getElementById('discord-status-text');
          const statusDetails = document.getElementById('discord-status-details');
          const botTag = document.getElementById('discord-bot-tag');
          const uptimeValue = document.getElementById('discord-uptime-value');

          if (response && response.connected) {
            statusDot.className = 'status-dot connected';
            statusText.textContent = '‚úì Connected';
            statusDetails.textContent = 'Discord bot is online and responding to commands';
            botTag.textContent = response.username || 'Unknown';
            uptimeValue.textContent = response.uptime || '0s';
          } else if (response && response.error) {
            statusDot.className = 'status-dot disconnected';
            statusText.textContent = '‚úó Disconnected';
            statusDetails.textContent = response.error;
            botTag.textContent = 'N/A';
            uptimeValue.textContent = 'N/A';
          } else {
            statusDot.className = 'status-dot warning';
            statusText.textContent = '‚ö† Unknown';
            statusDetails.textContent = 'Unable to determine Discord connection status';
            botTag.textContent = 'N/A';
            uptimeValue.textContent = 'N/A';
          }
        });
      }

      let instancesListExpanded = false;

      function toggleInstancesList() {
        instancesListExpanded = !instancesListExpanded;
        const container = document.getElementById('instances-container');
        const arrow = document.getElementById('instances-arrow');
        container.style.display = instancesListExpanded ? 'block' : 'none';
        arrow.textContent = instancesListExpanded ? '‚ñº' : '‚ñ∂';
        if (instancesListExpanded) loadAllInstances();
      }

      function loadAllInstances() {
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) return;

        dashboardSocket.emit('request_all_instances', {}, (response) => {
          console.log('All instances response:', response);
          renderInstancesList(response);
        });
      }

      // Load just the instance count (for initial page load)
      function loadInstanceCount() {
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) {
          console.warn('Dashboard socket not available for loadInstanceCount');
          return;
        }

        console.log('Requesting instance count...');
        dashboardSocket.emit('request_all_instances', {}, (response) => {
          console.log('Instance count response:', response);
          const countEl = document.getElementById('instances-count');
          if (response && response.instances) {
            countEl.textContent = response.instances.length;
          } else {
            countEl.textContent = '?';
          }
        });
      }

      function renderInstancesList(response) {
        const authorizedListEl = document.getElementById('authorized-list');
        const unauthorizedListEl = document.getElementById('unauthorized-list');
        const countEl = document.getElementById('instances-count');
        const authorizedCountEl = document.getElementById('authorized-count');
        const unauthorizedCountEl = document.getElementById('unauthorized-count');
        const alertEl = document.getElementById('instances-alert');

        // Handle tracking server unavailable gracefully
        if (!response || !response.instances) {
          authorizedListEl.innerHTML = '<div style="opacity: 0.7">Unable to load</div>';
          unauthorizedListEl.innerHTML = '<div style="opacity: 0.7">Unable to load</div>';
          countEl.textContent = '?';
          return;
        }

        const instances = response.instances || [];

        // Split based on authorized status from tracking server
        const authorized = instances.filter(i => {
          if (i.revoked) return false;
          if (i.isLocal) return true; // Local instance always authorized
          return i.authorized === true;
        });
        const unauthorized = instances.filter(i => {
          if (i.revoked) return true; // Revoked go to unauthorized
          if (i.isLocal) return false; // Local instance never unauthorized
          return i.authorized !== true;
        });

        countEl.textContent = instances.length;
        authorizedCountEl.textContent = authorized.length;
        unauthorizedCountEl.textContent = unauthorized.length;
        alertEl.style.display = unauthorized.length > 0 ? 'inline' : 'none';

        // Render authorized
        if (authorized.length === 0) {
          authorizedListEl.innerHTML = '<div style="opacity: 0.7; padding: 8px">No authorized instances</div>';
        } else {
          const degradedNote = response.trackingUnavailable 
            ? '<div style="opacity: 0.6; font-size: 0.75rem; padding: 4px 8px; border-bottom: 1px solid rgba(255,255,255,0.1)">‚ÑπÔ∏è Tracking server unavailable - showing local instance</div>' 
            : '';
          authorizedListEl.innerHTML = degradedNote + authorized.map(inst => renderInstanceCard(inst, false)).join('');
        }

        // Render unauthorized
        if (unauthorized.length === 0) {
          unauthorizedListEl.innerHTML = '<div style="opacity: 0.7; padding: 8px">None detected ‚úì</div>';
        } else {
          unauthorizedListEl.innerHTML = unauthorized.map(inst => renderInstanceCard(inst, true)).join('');
        }
      }

      function renderInstanceCard(inst, isUnauthorized) {
        const bgColor = inst.revoked ? 'rgba(239,68,68,0.2)' 
          : isUnauthorized ? 'rgba(251,191,36,0.2)' 
          : 'rgba(34,197,94,0.15)';
        const borderColor = inst.revoked ? '#ef4444' 
          : isUnauthorized ? '#fbbf24' 
          : 'rgba(34,197,94,0.5)';
        const statusIcon = inst.revoked ? 'üö´' : inst.online ? 'üü¢' : 'üî¥';
        const statusLabel = inst.revoked ? 'REVOKED' : inst.online ? 'Online' : 'Offline';

        // Action buttons based on status
        const approveBtn = (isUnauthorized || inst.revoked) 
          ? `<button onclick="approveInstance('${inst.instanceId}')" style="
              background: #22c55e; color: white; border: none; border-radius: 4px;
              padding: 4px 10px; font-size: 0.75rem; cursor: pointer;
            ">‚úì Approve</button>` 
          : '';
        const revokeBtn = !inst.revoked 
          ? `<button onclick="revokeInstance('${inst.instanceId}')" style="
              background: #ef4444; color: white; border: none; border-radius: 4px;
              padding: 4px 10px; font-size: 0.75rem; cursor: pointer;
            ">‚úó Revoke</button>` 
          : '';

        return `
          <div style="
            background: ${bgColor}; 
            border: 1px solid ${borderColor};
            border-radius: 8px; 
            padding: 10px; 
            margin-bottom: 8px;
            font-size: 0.85rem;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px">
              <div>
                <strong>${statusIcon} ${inst.clientName || 'Unknown Bot'}</strong>
                <span style="opacity: 0.7; margin-left: 8px; font-size: 0.8rem">${statusLabel}</span>
              </div>
              <div style="display: flex; gap: 6px; align-items: center">
                ${approveBtn}
                ${revokeBtn}
              </div>
            </div>
            <div style="margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.8rem; opacity: 0.9">
              <span>üìç ${inst.location || 'Unknown'}</span>
              <span>üåê ${inst.ip || 'Unknown'}</span>
              <span>üñ•Ô∏è ${inst.guilds || 0} servers</span>
            </div>
            <div style="margin-top: 4px; display: flex; justify-content: space-between; align-items: center">
              <span style="font-size: 0.75rem; opacity: 0.7">
                üïê Last seen: ${inst.lastHeartbeat ? new Date(inst.lastHeartbeat).toLocaleString() : 'Never'}
              </span>
              <span style="font-size: 0.65rem; opacity: 0.5; font-family: monospace">${inst.instanceId?.substring(0, 20) || 'N/A'}...</span>
            </div>
          </div>
        `;
      }

      function approveInstance(instanceId) {
        if (!confirm('Approve this instance? It will be marked as authorized.')) return;
        
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) return alert('Dashboard not connected');

        dashboardSocket.emit('instance_action', { action: 'approve', instanceId }, (response) => {
          if (response?.success) {
            alert('Instance approved successfully');
            loadAllInstances();
          } else {
            alert('Failed to approve: ' + (response?.error || 'Unknown error'));
          }
        });
      }

      function revokeInstance(instanceId) {
        if (!confirm('Revoke this instance? The bot will shut down if REQUIRE_VERIFICATION is enabled.')) return;
        
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) return alert('Dashboard not connected');

        dashboardSocket.emit('instance_action', { action: 'revoke', instanceId }, (response) => {
          if (response?.success) {
            alert('Instance revoked successfully');
            loadAllInstances();
          } else {
            alert('Failed to revoke: ' + (response?.error || 'Unknown error'));
          }
        });
      }

      function loadInstanceStatus() {
        const dashboardSocket = window.dashboard?.socket;
        if (!dashboardSocket) {
          console.warn('Dashboard socket not ready for instance status');
          return;
        }

        dashboardSocket.emit('request_instance_status', {}, (response) => {
          console.log('Instance status response:', response);

          const statusDot = document.getElementById('tracking-status-dot');
          const statusText = document.getElementById('tracking-status-text');
          const statusDetails = document.getElementById('tracking-status-details');
          const instanceId = document.getElementById('tracking-instance-id');
          const location = document.getElementById('tracking-location');
          const ip = document.getElementById('tracking-ip');

          if (!response || response.error) {
            statusDot.className = 'status-dot disconnected';
            statusText.textContent = '‚úó Error';
            statusDetails.textContent = response?.error || 'Unable to get tracking status';
            instanceId.textContent = 'N/A';
            location.textContent = 'N/A';
            ip.textContent = 'N/A';
            return;
          }

          if (!response.trackingEnabled) {
            statusDot.className = 'status-dot warning';
            statusText.textContent = '‚ö† Disabled';
            statusDetails.textContent = 'Instance tracking is not enabled';
            instanceId.textContent = 'N/A';
            location.textContent = 'N/A';
            ip.textContent = 'N/A';
          } else if (response.isVerified) {
            statusDot.className = 'status-dot connected';
            statusText.textContent = '‚úì Verified';
            statusDetails.textContent = 'Instance registered with tracking server';
            instanceId.textContent = response.instanceId || 'Pending';
            
            const loc = response.locationInfo;
            if (loc && loc.city) {
              location.textContent = `${loc.city}, ${loc.country || loc.countryCode || ''}`;
              ip.textContent = loc.ip || 'Unknown';
            } else {
              location.textContent = 'Unknown';
              ip.textContent = 'Unknown';
            }
          } else {
            // Show instance info even in degraded mode (tracking unavailable)
            statusDot.className = 'status-dot warning';
            statusText.textContent = '‚úì Verified';
            statusDetails.textContent = 'Instance registered with tracking server';
            instanceId.textContent = response.instanceId || 'local';
            
            const loc = response.locationInfo;
            if (loc) {
              if (loc.city && loc.country) {
                location.textContent = `${loc.city}, ${loc.country || loc.countryCode || ''}`;
              } else {
                location.textContent = loc.ip && loc.ip !== 'unknown' ? 'Unknown' : 'Unknown';
              }
              ip.textContent = loc.ip && loc.ip !== 'unknown' ? loc.ip : 'Unknown';
            } else {
              location.textContent = 'Unknown';
              ip.textContent = 'Unknown';
            }
          }
        });
      }

      // Mark the current active nav item
      document.addEventListener('DOMContentLoaded', () => {
        const currentPagePath = window.location.pathname;
        const currentPageName = currentPagePath.split('/').pop() || 'index.html';
        const navLinks = document.querySelectorAll('.navbar-item');
        navLinks.forEach((link) => {
          const linkHref = link.getAttribute('href');
          if (
            linkHref === currentPageName ||
            linkHref === currentPagePath.substring(1) ||
            linkHref.includes(currentPageName)
          ) {
            link.classList.add('active');
          }
        });

        // Wait for dashboard to initialize, then load services
        const initServices = () => {
          if (window.dashboard && window.dashboard.socket) {
            console.log('Dashboard ready, loading services and status');
            loadServices();
            loadDiscordStatus();
            loadInstanceStatus();
            loadInstanceCount(); // Load instance count immediately

            // Refresh Discord status every 30 seconds
            setInterval(loadDiscordStatus, 30000);
            // Refresh instance status every 60 seconds
            setInterval(loadInstanceStatus, 60000);
            // Refresh instance count every 60 seconds
            setInterval(loadInstanceCount, 60000);
          } else {
            setTimeout(initServices, 100);
          }
        };

        initServices();
      });
    </script>
  </body>
</html>
