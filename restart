#!/bin/bash
# Restart the Aszune AI Bot
# Usage: ./restart or cd /aszune-ai-bot && ./restart

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

echo "ğŸ”„ Restarting Aszune AI Bot..."

# Try systemd first (if bot is running as a service)
if command -v systemctl &> /dev/null && systemctl is-active --quiet aszune-ai-bot; then
    echo "ğŸ“‹ Using systemctl to restart service..."
    sudo systemctl restart aszune-ai-bot
    sleep 2
    if systemctl is-active --quiet aszune-ai-bot; then
        echo "âœ… Bot restarted successfully via systemctl"
        systemctl status aszune-ai-bot
    else
        echo "âš ï¸  Service restart command executed but status is unclear"
        systemctl status aszune-ai-bot
    fi
else
    # Fallback: kill existing process and start new one
    echo "ğŸš€ Using direct process management..."
    
    # Kill existing node processes running the bot
    if pgrep -f "node src/index.js" > /dev/null; then
        echo "â¹ï¸  Stopping existing bot process..."
        pkill -f "node src/index.js" || true
        sleep 1
    fi
    
    # Start the bot in background
    echo "â–¶ï¸  Starting bot..."
    nohup npm start > /dev/null 2>&1 &
    sleep 2
    
    # Verify it's running
    if pgrep -f "node src/index.js" > /dev/null; then
        echo "âœ… Bot started successfully!"
        ps aux | grep "node src/index.js" | grep -v grep
    else
        echo "âŒ Failed to start bot"
        exit 1
    fi
fi

echo ""
echo "ğŸ’¡ Tip: Use 'npm run restart' for the same functionality"
echo "ğŸŒ Dashboard: http://$(hostname -I | awk '{print $1}'):3000"
